<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSC44NDPLQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LSC44NDPLQ');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS Code GitHub Copilot Agent Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="step.css">
    <link rel="stylesheet" href="light-theme.css">
    <script src="theme-toggle.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="header-brand">
                <span>üéÆ</span>
                <span class="header-title">VS Code Copilot Agent Lab</span>
            </a>
            <nav class="header-nav">
                <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è Light</button>
                <button class="nav-btn" id="prevBtn" disabled>‚Üê Previous</button>
                <button class="nav-btn" id="nextBtn">Next ‚Üí</button>
            </nav>
        </div>
    </header>

    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Lab Parts</div>
                <nav id="stepNav"></nav>
            </div>
        </aside>

        <main class="main">
            <article class="content">
                <div id="markdown-content" class="markdown">
                    <div class="loading">Loading content</div>
                </div>
                <nav class="nav-footer">
                    <a href="#" class="nav-footer-btn disabled" id="prevLink">‚Üê Previous</a>
                    <a href="#" class="nav-footer-btn" id="nextLink">Next ‚Üí</a>
                </nav>
            </article>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script>
        const steps = [
            { id: 'guide', file: 'GUIDE.md', title: 'Quick Reference', number: 'üìö' },
            { id: '00-overview', file: '00-overview.md', title: 'Overview & Checklist', number: '00' },
            { id: '01-setup', file: '01-setup.md', title: 'Setup & Context Engineering', number: '01' },
            { id: '02-design', file: '02-design.md', title: 'Design-First Frontend', number: '02' },
            { id: '03-quiz-master', file: '03-quiz-master.md', title: 'Custom Quiz Master', number: '03' },
            { id: '04-multi-agent', file: '04-multi-agent.md', title: 'Multi-Agent Development', number: '04' },
            { id: '05-complete', file: '05-complete.md', title: 'üéâ Complete!', number: 'üéâ' },
        ];

        function celebrate() {
            const duration = 3000;
            const end = Date.now() + duration;
            const colors = ['#00f5ff', '#ff00ff', '#b366ff', '#00ff88', '#ffff00'];
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/copilot-dev-days/agent-lab-typescript/main/workshop/';

        function getCurrentStepId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('step') || '00-overview';
        }

        function getCurrentStepIndex() {
            return steps.findIndex(s => s.id === getCurrentStepId());
        }

        function buildSidebar() {
            const nav = document.getElementById('stepNav');
            const currentId = getCurrentStepId();
            nav.innerHTML = steps.map(step => `
                <a href="?step=${step.id}" class="step-link ${step.id === currentId ? 'active' : ''}">
                    <span class="step-number">${step.number}</span>
                    <span>${step.title}</span>
                </a>
            `).join('');
        }

        function updateNavigation() {
            const idx = getCurrentStepIndex();
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const prevLink = document.getElementById('prevLink');
            const nextLink = document.getElementById('nextLink');

            prevBtn.disabled = idx <= 0;
            nextBtn.disabled = idx >= steps.length - 1;
            prevBtn.onclick = () => idx > 0 && (window.location.search = `?step=${steps[idx - 1].id}`);
            nextBtn.onclick = () => idx < steps.length - 1 && (window.location.search = `?step=${steps[idx + 1].id}`);

            if (idx > 0) {
                prevLink.href = `?step=${steps[idx - 1].id}`;
                prevLink.textContent = `‚Üê ${steps[idx - 1].title}`;
                prevLink.classList.remove('disabled');
            } else {
                prevLink.classList.add('disabled');
                prevLink.textContent = '‚Üê Previous';
            }

            if (idx < steps.length - 1) {
                nextLink.href = `?step=${steps[idx + 1].id}`;
                nextLink.textContent = `${steps[idx + 1].title} ‚Üí`;
                nextLink.classList.remove('disabled');
            } else {
                nextLink.classList.add('disabled');
                nextLink.textContent = 'Next ‚Üí';
            }
        }

        function processMarkdown(md) {
            // Remove header/footer nav lines
            md = md.replace(/\[üìö Lab Guide\][^\n]+\n+---/g, '');
            md = md.replace(/\[üìö Lab Guide\][^\n]+/g, '');
            md = md.replace(/\[üéÆ Live Demo\][^\n]+\n+---/g, '');
            md = md.replace(/\[üéÆ Live Demo\][^\n]+/g, '');
            md = md.replace(/\[‚Üê README\][^\n]+/g, '');
            md = md.replace(/\[‚Üê Overview\][^\n]+/g, '');
            md = md.replace(/\[‚Üê Part \d+\][^\n]+/g, '');
            md = md.replace(/üëâ \*\*\[Continue to[^\n]+/g, '');
            md = md.replace(/üëâ \*\*\[Start with[^\n]+/g, '');

            // Convert relative game link to absolute
            md = md.replace(/\]\(\.\.\/game\/\)/g, '](game/)');

            // Convert internal markdown links to step viewer links
            md = md.replace(/\]\((\d+)-([^)]+)\.md\)/g, '](step.html?step=$1-$2)');
            md = md.replace(/\]\(GUIDE\.md\)/g, '](step.html?step=guide)');

            // Handle GitHub-style alerts
            md = md.replace(/>\s*üí°\s*\*\*Tip:\*\*/gi, '> **üí° Tip**');
            md = md.replace(/>\s*üí°\s*\*\*(Optional)[,:]\*\*/gi, '> **üí° $1**');
            md = md.replace(/>\s*üí°\s*\*\*(Think about)[,:]\*\*/gi, '> **üí° $1**');

            // Clean up multiple consecutive horizontal rules
            md = md.replace(/---\s*\n\s*---/g, '---');

            return md;
        }

        async function loadContent() {
            const idx = getCurrentStepIndex();
            if (idx === -1) {
                document.getElementById('markdown-content').innerHTML = '<p>Step not found. <a href="?step=00-overview">Go to Overview</a></p>';
                return;
            }

            const step = steps[idx];
            document.title = `${step.title} | VS Code Copilot Agent Lab`;

            try {
                const response = await fetch(`${GITHUB_RAW_BASE}${step.file}`);
                if (!response.ok) throw new Error('Failed to load');

                let md = await response.text();
                md = processMarkdown(md);

                // Fix relative image paths to resolve against the markdown file's directory
                const stepDir = step.file.substring(0, step.file.lastIndexOf('/') + 1);
                md = md.replace(/!\[([^\]]*)\]\((?!https?:\/\/|\/\/)([^)]+)\)/g, (match, alt, path) => {
                    const cleanPath = path.replace(/^\.\//, '');
                    return `![${alt}](${GITHUB_RAW_BASE}${stepDir}${cleanPath})`;
                });

                marked.setOptions({ breaks: true, gfm: true });
                document.getElementById('markdown-content').innerHTML = marked.parse(md);

                if (step.id === '05-complete') {
                    setTimeout(celebrate, 500);
                }
            } catch (error) {
                document.getElementById('markdown-content').innerHTML = `
                    <h1>Error Loading Content</h1>
                    <p>Could not load ${step.file}. Please check your internet connection.</p>
                    <p><a href="index.html">Return to home</a></p>
                `;
            }
        }

        buildSidebar();
        updateNavigation();
        loadContent();

        document.addEventListener('keydown', (e) => {
            const idx = getCurrentStepIndex();
            if (e.key === 'ArrowLeft' && idx > 0) {
                window.location.search = `?step=${steps[idx - 1].id}`;
            } else if (e.key === 'ArrowRight' && idx < steps.length - 1) {
                window.location.search = `?step=${steps[idx + 1].id}`;
            }
        });
    </script>
</body>
</html>
